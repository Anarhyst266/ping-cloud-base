kind: Kustomization
apiVersion: kustomize.config.k8s.io/v1beta1

resources:

# Deploy cert-manager as part of the bootstrap process so that it has time to register with the ACME server
- ${K8S_GIT_URL}/k8s-configs/cluster-tools/cert-manager/route53?ref=${K8S_GIT_BRANCH}

# Deploy the network provider so that flux is able to talk to the Kubernetes API server under all circumstances
- ${K8S_GIT_URL}/k8s-configs/cluster-tools/network-provider?ref=${K8S_GIT_BRANCH}

# Deploy flux
- ${K8S_GIT_URL}/k8s-configs/cluster-tools/git-ops?ref=${K8S_GIT_BRANCH}
- known-hosts-config.yaml

patchesStrategicMerge:

### Lets encrypt ACME certificate issuer for the cluster ###
- |-
  apiVersion: certmanager.k8s.io/v1alpha1
  kind: ClusterIssuer
  metadata:
    name: letsencrypt-prod
  spec:
    acme:
      email: ${CLUSTER_NAME_LC}@${DNS_DOMAIN_PREFIX}${TENANT_DOMAIN}
      solvers:
      - dns01:
          route53:
            region: ${REGION}
        selector:
          dnsZones:
          - ${DNS_DOMAIN_PREFIX}${TENANT_DOMAIN}

### Additional args to the flux deployment object ###
- |-
  apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: flux
    namespace: flux
  spec:
    template:
      spec:
        containers:
        - name: flux
          args:
          - --manifest-generation=true
          - --git-url=${CLUSTER_STATE_REPO_URL}
          - --git-path=k8s-configs/${ENVIRONMENT_GIT_PATH}
          volumeMounts:
          - name: ssh-config
            mountPath: /root/.ssh
        volumes:
        - name: ssh-config
          configMap:
            name: flux-ssh-config
            defaultMode: 0644

### Deploy key to the cluster state repo ###
- |-
  apiVersion: v1
  kind: Secret
  type: Opaque
  metadata:
    name: flux-git-deploy
    namespace: flux
  data:
    identity: |
      ${SSH_ID_KEY_BASE64}